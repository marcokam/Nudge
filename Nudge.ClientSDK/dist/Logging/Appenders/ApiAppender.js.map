{"version":3,"file":"ApiAppender.js","sourceRoot":"","sources":["../../../Logging/Appenders/ApiAppender.ts"],"names":[],"mappings":"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","sourcesContent":["import { LogAppender, LogEvent, LogLevel } from \"../LoggingInterfaces\";\r\nimport { resolveString, resolveFunction } from \"~/Util/utils\";\r\nimport ApiClient from \"~/Api/ApiInterfaces\";\r\nimport { voidPromise } from \"~/Util/PromiseUtils\";\r\n\r\nconst promiseEmpty = Promise.resolve(null);\r\nconst apiRoutes = {\r\n    [LogLevel.error]: \"error\",\r\n    [LogLevel.warning]: \"warning\",\r\n    [LogLevel.info]: undefined,\r\n    [LogLevel.debug]: undefined\r\n};\r\n\r\nfunction errorTypeName(obj: any): string {\r\n\r\n    try {\r\n        return Object.getPrototypeOf(obj).constructor.name;\r\n    } catch (e1) {\r\n        // noop\r\n    }\r\n    try {\r\n        return Object.getPrototypeOf(obj).name;\r\n    } catch (e2) {\r\n        // noop\r\n    }\r\n    try {\r\n        return Object.prototype.toString.call(obj).slice(8, -1);\r\n    } catch (e3) {\r\n        // noop\r\n    }\r\n\r\n    return \"\";\r\n}\r\n\r\ninterface ExceptionProperties {\r\n    message?: string;\r\n    exception?: string;\r\n    exceptionDetails?: string;\r\n    additionalProperties?: any;\r\n};\r\nfunction resolveExceptionProperties(err: Error): ExceptionProperties {\r\n    if (!err) return {};\r\n    err = resolveFunction(err);\r\n    if (!err) return {};\r\n    const message: string = err.message || resolveString(err);\r\n    const exception: string = errorTypeName(err);\r\n    const additionalProperties: any = {\r\n        ...err,\r\n    };\r\n    additionalProperties.stack = undefined;\r\n    additionalProperties.message = undefined;\r\n\r\n    return {\r\n        message,\r\n        exception,\r\n        exceptionDetails: err.stack,\r\n        additionalProperties,\r\n    };\r\n}\r\nfunction addMetaDataToBody(body: any, ambientProperties?: any): any {\r\n\r\n    // Resolve ambientProperties\r\n    const additionalAmbientProperties: any = {};\r\n    if (ambientProperties) {\r\n        Object.entries(ambientProperties).forEach(([key, value]) => {\r\n            additionalAmbientProperties[key] = resolveFunction(value);\r\n        });\r\n    }\r\n\r\n    return {\r\n        ...body,\r\n        additionalProperties: {\r\n            ...additionalAmbientProperties,\r\n            ...body.additionalProperties,\r\n        }\r\n    };\r\n}\r\n\r\ntype AmbientPropertiesFunc = () => any | undefined;\r\n\r\n//TODO: Deprecate this once we are confident in the implementation of createExceptionRegexFilter.\r\nexport const createExceptionFilter = (exception: string, message?: string) => (_: LogLevel, body: ExceptionProperties) =>\r\n    !(body && body.exception == exception && (!message || body.message == message));\r\n\r\nexport const createExceptionRegexFilter = (exceptionRegExp: RegExp, messageRegExp?: RegExp) => (_: LogLevel, body: ExceptionProperties) => {\r\n    // Exception doesn't match\r\n    if (!body || !body.exception || !body.exception.match(exceptionRegExp)) {\r\n        return true;\r\n    }\r\n\r\n    // Exception matches and we don't have a Message filter\r\n    if (!messageRegExp) {\r\n        return false;\r\n    }\r\n\r\n    // Message doesn't match    \r\n    if (!body || !body.message || !body.message.match(messageRegExp)) {\r\n        return true;\r\n    }\r\n\r\n    // Both match\r\n    return false;\r\n};\r\n\r\nexport const joinLogFilters = (...filters: LogFilter[]): LogFilter => (level: LogLevel, body: ExceptionProperties) => \r\n    !filters.find(f => !f(level, body));\r\nexport const abortFilter = createExceptionFilter(\"DOMException\", \"The user aborted a request.\");\r\n\r\n// Result of false signals to NOT log this exception\r\nexport type LogFilter = (level: LogLevel, body: ExceptionProperties) => boolean;\r\n\r\nexport default class ApiAppender implements LogAppender {\r\n\r\n    private readonly apiClient: ApiClient;\r\n    private readonly logApiPrefix: string;\r\n    private readonly ambientProperties?: AmbientPropertiesFunc;\r\n    private readonly logFilter: LogFilter;\r\n\r\n    constructor(apiClient: ApiClient, logApiPrefix: string, ambientProperties?: AmbientPropertiesFunc, logFilter?: LogFilter) {\r\n        this.apiClient = apiClient;\r\n        this.logApiPrefix = logApiPrefix;\r\n        this.ambientProperties = ambientProperties;\r\n        this.logFilter = logFilter || (() => true);\r\n    }\r\n\r\n    append(event: LogEvent): Promise<void> {\r\n        const apiRoute: string | undefined = apiRoutes[event.level];\r\n        if (!apiRoute) {\r\n            return voidPromise;\r\n        }\r\n\r\n        const args = event.args();\r\n\r\n        // Get Error objects\r\n        const firstErrArgIndex = args.findIndex(_ => _ instanceof Error);\r\n        const firstErrArg = firstErrArgIndex === -1 ? null : args[firstErrArgIndex];\r\n        const otherArgs = firstErrArg === null ? args : args.filter((_, index) => index !== firstErrArgIndex);\r\n\r\n        const message = otherArgs.map(_ => resolveString(_)).join(\" \");\r\n\r\n        if (!firstErrArg) {\r\n            return this.sendToApi(event.level, apiRoute, { message });\r\n        }\r\n        const ex = resolveExceptionProperties(firstErrArg as Error);\r\n        const body: ExceptionProperties = {\r\n            ...ex,\r\n            message: message,\r\n        };\r\n        return this.sendToApi(event.level, apiRoute, body);\r\n    }\r\n\r\n    private sendToApi(logLevel: LogLevel, apiRoute: string | undefined, body: ExceptionProperties): Promise<any> {\r\n        if (!apiRoute || body === null || !this.logFilter(logLevel, body)) {\r\n            return promiseEmpty;\r\n        }\r\n        const url = `${this.logApiPrefix}${apiRoute}`;\r\n        const ambientProperties = this.ambientProperties && this.ambientProperties();\r\n        const actualBody = addMetaDataToBody(body, ambientProperties);\r\n        return this.apiClient.postJson(url, actualBody);\r\n    }\r\n}"]}